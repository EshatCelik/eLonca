<div class="customer-edit-page">
  <!-- Top Section -->
  <div class="top-section">
    <!-- Financial Summary -->
    @if (customer && !isLoading) {
      <div class="financial-summary-wrapper">
        <div class="financial-summary receivable" [ngClass]="financialStatus === 'positive' || financialStatus === 'neutral' ? 'positive' : 'neutral'">
          <div class="financial-icon">
            <i class="fas fa-arrow-down"></i>
          </div>
          <div class="financial-content">
            <span class="financial-label">Alacağım</span>
            <span class="financial-amount">{{ customer.totalReceivable | currency:'$' }}</span>
          </div>
        </div>
        
        <div class="financial-summary payable" [ngClass]="financialStatus === 'negative' ? 'negative' : 'neutral'">
          <div class="financial-icon">
            <i class="fas fa-arrow-up"></i>
          </div>
          <div class="financial-content">
            <span class="financial-label">Borcum</span>
            <span class="financial-amount">{{ customer.totalDept | currency:'$' }}</span>
          </div>
        </div>
      </div>
    }

    <!-- Customer Info Bar -->
    <div class="customer-info-bar">
      <div class="customer-details">
        <span class="customer-code-display">{{ customer?.customerCode || '-' }}</span>
        <span class="status-badge" [ngClass]="{
          'active': customer?.isActive,
          'inactive': !customer?.isActive
        }">
          {{ customer?.isActive ? 'Aktif' : 'Pasif' }}
        </span> 
        <p class="customer-type">{{ getCustomerType(customer?.customerType) }}</p>
      </div>
      
      <div class="action-buttons">
        <button type="button" class="btn btn-secondary" (click)="onClose()">
          <i class="fas fa-arrow-left"></i> Geri Dön
        </button>
        <button type="button" class="btn btn-primary" (click)="onSave()" [disabled]="isSaving">
          <i class="fas fa-save"></i> {{ isSaving ? 'Kaydediliyor...' : 'Güncelle' }}
        </button>
      </div>
    </div>
  </div>

  @if (isLoading) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Yükleniyor...</p>
    </div>
  }

  @if (!isLoading && !customer) {
    <div class="error-container">
      <h3>Müşteri bulunamadı</h3>
      <p>API'den veri alınamadı</p>
    </div>
  }

  @if (customer && !isLoading) {
    <div class="content-container">
      <div class="customer-card"> 
 
        <div class="card-body">
          <div class="info-section">
            <h3><i class="fas fa-info-circle"></i> Müşteri Bilgileri</h3>
            <div class="info-grid">
              <div class="info-item">
                <label><i class="fas fa-barcode"></i> Müşteri Kodu</label>
                <input type="text" [(ngModel)]="customer.customerCode" class="form-input" placeholder="Müşteri kodu" />
              </div>
              <div class="info-item">
                <label><i class="fas fa-store"></i> Mağaza Adı</label>
                <input type="text" [(ngModel)]="customer.storeName" class="form-input" placeholder="Mağaza adı" />
              </div>
              <div class="info-item">
                <label><i class="fas fa-tag"></i> Müşteri Tipi</label>
                <select [(ngModel)]="customer.customerType" class="form-input">
                  <option value="">Müşteri tipi seçin</option>
                  <option value="1">Bireysel</option>
                  <option value="2">Kurumsal</option>
                </select>
              </div>
              <div class="info-item">
                <label><i class="fas fa-percentage"></i> İndirim Oranı</label>
                <div class="input-with-icon">
                  <input type="number" [(ngModel)]="customer.discountRate" class="form-input" placeholder="0" min="0" max="100" step="0.01" />
                  <span class="input-icon">%</span>
                </div>
              </div>
            </div>
          </div>

          <div class="info-section">
            <h3><i class="fas fa-phone-alt"></i> İletişim Bilgileri</h3>
            <div class="info-grid">
              <div class="info-item">
                <label><i class="fas fa-phone"></i> Telefon</label>
                <input type="tel" [(ngModel)]="customer.phone" class="form-input" placeholder="Telefon numarası" />
              </div>
              <div class="info-item">
                <label><i class="fas fa-envelope"></i> Email</label>
                <input type="email" [(ngModel)]="customer.email" class="form-input" placeholder="Email adresi" />
              </div>
              <div class="info-item full-width">
                <label><i class="fas fa-map-marker-alt"></i> Adres</label>
                <textarea [(ngModel)]="customer.address" class="form-input" placeholder="Adres bilgileri" rows="3"></textarea>
              </div>
            </div>
          </div>

          <div class="info-section">
            <h3><i class="fas fa-cog"></i> Diğer Ayarlar</h3>
            <div class="settings-grid">
              <div class="setting-item">
                <label class="switch">
                  <input type="checkbox" [(ngModel)]="customer.isActive" />
                  <span class="slider"></span>
                </label>
                <div class="setting-info">
                  <h4>Aktif Müşteri</h4>
                  <p>Bu müşterinin sistemde aktif olup olmadığını belirler</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sales Section -->
      <div class="data-card">
        <div class="card-header">
          <h3><i class="fas fa-shopping-cart"></i> Aktif Satışlarım</h3>
          <div class="header-buttons">
            <button type="button" class="btn btn-warning btn-sm" (click)="openReturnModal()">
              <i class="fas fa-undo"></i> İade Ekle
            </button>
            <button type="button" class="btn btn-primary btn-sm" (click)="openSalesModal()">
              <i class="fas fa-plus"></i> Satış Ekle
            </button>
          </div>
        </div>
        <div class="card-body">
          @if (isLoadingSales) {
            <div class="loading-small">
              <div class="loading-spinner-small"></div>
              <span>Satışlar yükleniyor...</span>
            </div>
          } @else if (sales.length === 0) {
            <div class="empty-state">
              <i class="fas fa-shopping-cart"></i>
              <h4>Henüz satış kaydı yok</h4>
              <p>"Satış Ekle" butonuna tıklayarak ilk satışınızı ekleyin</p>
            </div>
          } @else {
            <div class="sales-table-container">
              <table class="sales-table">
                <thead>
                  <tr>
                    <th><i class="fas fa-receipt"></i> Ürünler </th>
                    <th><i class="fas fa-receipt"></i> Fiş No</th>
                    <th><i class="fas fa-calendar"></i> Tarih</th>
                    <th><i class="fas fa-exchange-alt"></i> İşlem Yapan</th>
                    <th><i class="fas fa-exchange-alt"></i> İşlem</th>
                    <th><i class="fas fa-store"></i> Mağaza</th>
                    <th><i class="fas fa-money-bill"></i> Tutar</th>
                    <th><i class="fas fa-info-circle"></i> Durum</th>
                  </tr>
                </thead>
                <tbody>
                  @for (sale of sales; track sale.id) {
                    <tr (click)="goToSaleDetail(sale)" class="clickable-row" [ngClass]="{
                      'sale-row': sale.isSale === true,
                      'purchase-row': sale.isSale === false
                    }">
                    <td class="invoice-cell">
                      <div class="invoice-info">
                        <span class="invoice-number">{{ sale.products }}</span> 
                      </div>
                    </td>
                      <td class="invoice-cell">
                        <div class="invoice-info">
                          <span class="invoice-number">{{ sale.invoiceNumber }}</span> 
                        </div>
                      </td>
                      <td class="date-cell">{{ sale.date | date:'yyyy-MM-dd HH:mm' }}</td>
                      <td class="user-cell">
                        <div class="amount-info">
                          <span class="sale-user">{{ sale.saleUser }}</span>
                        </div>
                      </td>
                      <td class="transaction-cell">
                        <span class="transaction-badge" [ngClass]="{
                          'sale-badge': isSellerStore(sale),
                          'purchase-badge': !isSellerStore(sale)
                        }">
                          <i class="fas" [ngClass]="{
                            'fa-arrow-up': isSellerStore(sale),
                            'fa-arrow-down': !isSellerStore(sale)
                          }"></i>
                          {{ isSellerStore(sale) ? 'Satış' : 'Alış' }}
                        </span>
                      </td>
                      <td class="store-cell">
                        <div class="store-info">
                          <div class="store-name">{{ getPartnerStoreName(sale) }}</div>
                          <small class="customer-code">{{ sale.sellerStoreName  || '-' }}</small>
                        </div>
                      </td>
                      <td class="amount-cell">
                        <div class="amount-info">
                          <span class="total-amount" *ngIf="sale.isSale">{{ sale.amount | currency:'$' }}</span>
                          <span class="total-amount" *ngIf="!sale.isSale">-{{ sale.amount | currency:'$' }}</span>
                        </div>
                      </td>
                      <td class="status-cell">
                        <div class="status-actions">
                          <span class="status-badge" [ngClass]="{
                            'paid': sale.paymentStatus === 1,
                            'pending': sale.paymentStatus === 0
                          }">
                            <i class="fas" [ngClass]="{
                              'fa-check-circle': sale.paymentStatus === 1,
                              'fa-clock': sale.paymentStatus === 0
                            }"></i>
                            {{ sale.paymentStatus === 1 ? 'Ödendi' : 'Bekliyor' }}
                          </span>
                          <button class="btn btn-warning btn-sm return-btn" (click)="openReturnModal(sale); $event.stopPropagation()" title="İade Gir">
                            <i class="fas fa-undo"></i>
                            İade Gir
                          </button>
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      </div> 
    </div>
  }

  <!-- Sales Modal -->
  @if (showSalesModal) {
    <div class="modal-overlay" (click)="closeSalesModal()">
      <div class="modal-content sales-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <div class="header-content">
            <h3><i class="fas fa-shopping-cart"></i> Yeni Satış Ekle</h3>
            <button type="button" class="modal-close" (click)="closeSalesModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        
        <div class="modal-body">
          <!-- Products Section -->
          <div class="products-section">
            <div class="section-header">
              <h4><i class="fas fa-box"></i> Satış Ürünleri</h4>
              <button type="button" class="btn btn-primary btn-sm" (click)="openProductModal()">
                <i class="fas fa-plus"></i> Ürün Ekle
              </button>
            </div>
            
            @if (saleProducts.length === 0) {
              <div class="empty-products">
                <i class="fas fa-box-open"></i>
                <p>Henüz ürün eklenmedi</p>
                <small>"Ürün Ekle" butonuna tıklayarak ürün ekleyin</small>
              </div>
            } @else {
              <div class="products-list">
                @for (product of saleProducts; track product.id) {
                  <div class="product-item">
                    <div class="product-info">
                      <div class="product-name">{{ product.productName }}</div>
                      <div class="product-details">
                        <span class="product-code">{{ product.productCode }}</span>
                        <span class="product-quantity">{{ product.quantity }} adet</span>
                        <span class="product-price">{{ formatCurrency(product.unitPrice) }}</span>
                      </div>
                    </div>
                    <div class="product-pricing">
                      <div class="pricing-row">
                        <span>Ara Toplam:</span>
                        <span>{{ formatCurrency(product.subtotal) }}</span>
                      </div>
                      @if (product.discountAmount > 0) {
                        <div class="pricing-row discount">
                          <span>İndirim:</span>
                          <span>-{{ formatCurrency(product.discountAmount) }}</span>
                        </div>
                      }
                      <div class="pricing-row total">
                        <span>Toplam:</span>
                        <span>{{ formatCurrency(product.totalPrice) }}</span>
                      </div>
                    </div>
                    <div class="product-actions">
                      <button type="button" class="btn btn-danger btn-sm" (click)="removeProductFromSale(product.id)">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
          
          <!-- Sale Details Section -->
          <div class="sale-details-section">
            <div class="section-title">
              <i class="fas fa-info-circle"></i>
              <span>Satış Bilgileri</span>
            </div>
            
            <div class="details-grid">
              <div class="detail-item">
                <label><i class="fas fa-calendar"></i> Tarih</label>
                <input type="date" [(ngModel)]="newSale.date" class="form-input">
              </div>
              
              <div class="detail-item">
                <label><i class="fas fa-info-circle"></i> Durum</label>
                <select [(ngModel)]="newSale.status" class="form-input">
                  <option value="paid">Ödendi</option>
                  <option value="pending">Bekliyor</option>
                </select>
              </div>
              
              <div class="detail-item full-width">
                <label><i class="fas fa-align-left"></i> Açıklama</label>
                <textarea [(ngModel)]="newSale.description" class="form-input" placeholder="Satış açıklaması..." rows="2"></textarea>
              </div>
            </div>
          </div>
          
          <!-- Total Summary -->
          <div class="total-summary">
            <div class="summary-card">
              <div class="summary-row">
                <span>Genel Toplam:</span>
                <span class="total-amount">{{ formatCurrency(newSale.totalAmount) }}</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <div class="footer-actions">
            <button type="button" class="btn btn-secondary" (click)="closeSalesModal()">
              <i class="fas fa-times"></i> İptal
            </button>
            <button type="button" class="btn btn-primary" (click)="updateSaveNewSale()" [disabled]="isSavingSale || saleProducts.length === 0">
              <i class="fas fa-save"></i> {{ isSavingSale ? 'Kaydediliyor...' : 'Kaydet' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Product Selection Modal -->
  @if (showProductModal) {
    <div class="modal-overlay" (click)="closeProductModal()">
      <div class="modal-content product-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <div class="header-content">
            <h3><i class="fas fa-box"></i> Ürün Seç</h3>
            <button type="button" class="modal-close" (click)="closeProductModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        
        <div class="modal-body">
          <!-- Product Selection -->
          <div class="product-selection">
            <div class="section-title">
              <i class="fas fa-search"></i>
              <span>Ürün Seçimi</span>
            </div>
            
            <div class="product-selector">
              <select [(ngModel)]="selectedProduct" class="form-input" (change)="onProductSelect()">
                <option value="">Ürün seçin</option>
                @for (product of availableProducts; track product.id) {
                  <option [value]="product.id">{{ product.name }} - {{ formatCurrency(product.price) }}</option>
                }
              </select>
            </div>
            
            @if (selectedProduct) {
              <div class="selected-product-info">
                <div class="product-details">
                  <div class="product-detail-item">
                    <label>Ürün Kodu:</label>
                    <span>{{ getSelectedProductCode() }}</span>
                  </div>
                  <div class="product-detail-item">
                    <label>Birim Fiyat:</label>
                    <span>{{ formatCurrency(getSelectedProductPrice()) }}</span>
                  </div>
                </div>
              </div>
            }
          </div>
          
          <!-- Quantity and Discount -->
          <div class="quantity-discount-section">
            <div class="section-title">
              <i class="fas fa-calculator"></i>
              <span>Miktar ve İndirim</span>
            </div>
            
            <div class="quantity-discount-grid">
              <div class="input-item">
                <label><i class="fas fa-cubes"></i> Miktar</label>
                <input type="number" [(ngModel)]="productQuantity" class="form-input" placeholder="1" min="1">
              </div>
              
              <div class="input-item">
                <label><i class="fas fa-percentage"></i> İndirim (%)</label>
                <input type="number" [(ngModel)]="productDiscount" class="form-input" placeholder="0" min="0" max="100">
              </div>
            </div>
          </div>
          
          <!-- Calculation Preview -->
          @if (selectedProduct && productQuantity > 0) {
            <div class="calculation-preview">
              <div class="section-title">
                <i class="fas fa-calculator"></i>
                <span>Hesaplama</span>
              </div>
              
              <div class="calculation-details">
                <div class="calc-row">
                  <span>Birim Fiyat:</span>
                  <span>{{ formatCurrency(getSelectedProductPrice()) }}</span>
                </div>
                <div class="calc-row">
                  <span>Miktar:</span>
                  <span>{{ productQuantity }} adet</span>
                </div>
                <div class="calc-row">
                  <span>Ara Toplam:</span>
                  <span>{{ formatCurrency(getSelectedProductPrice() * productQuantity) }}</span>
                </div>
                @if (productDiscount > 0) {
                  <div class="calc-row discount">
                    <span>İndirim:</span>
                    <span>-{{ formatCurrency((getSelectedProductPrice() * productQuantity) * (productDiscount / 100)) }}</span>
                  </div>
                }
                <div class="calc-row total">
                  <span>Toplam:</span>
                  <span>{{ formatCurrency((getSelectedProductPrice() * productQuantity) - ((getSelectedProductPrice() * productQuantity) * (productDiscount / 100))) }}</span>
                </div>
              </div>
            </div>
          }
        </div>
        
        <div class="modal-footer">
          <div class="footer-actions">
            <button type="button" class="btn btn-secondary" (click)="closeProductModal()">
              <i class="fas fa-times"></i> İptal
            </button>
            <button type="button" class="btn btn-primary" (click)="addProductToSale()" [disabled]="!selectedProduct || productQuantity <= 0">
              <i class="fas fa-plus"></i> Satışa Ekle
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Return Modal -->
  @if (showReturnModal) {
    <div class="modal-overlay" (click)="closeReturnModal()">
      <div class="modal-content return-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <div class="header-content">
            <h3><i class="fas fa-undo"></i> İade Ekle</h3>
            <button type="button" class="modal-close" (click)="closeReturnModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        
        <div class="modal-body">
          <!-- Products Section -->
          <div class="products-section">
            <div class="section-header">
              <h4><i class="fas fa-box"></i> İade Ürünleri</h4>
            </div>
            
            @if (returnProducts.length === 0) {
              <div class="empty-products">
                <i class="fas fa-box-open"></i>
                <p>Henüz ürün eklenmedi</p>
                <small>İade edilecek ürünler bulunamadı</small>
              </div>
            } @else {
              <div class="products-list">
                @for (product of returnProducts; track product.id) {
                  <div class="product-item">
                    <div class="product-info">
                      <div class="product-name">{{ product.productName }}</div>
                      <div class="product-details">
                        <span class="product-code">{{ product.productCode }}</span>
                        <span class="product-max">Maks: {{ product.maxQuantity || product.originalQuantity }} adet</span>
                        <span class="product-price">{{ formatCurrency(product.unitPrice) }}</span>
                      </div>
                    </div>
                    <div class="product-quantity-control">
                      <label>İade Miktarı:</label>
                      <input 
                        type="number" 
                        [(ngModel)]="product.quantity" 
                        class="form-input quantity-input" 
                        placeholder="0" 
                        min="0" 
                        [max]="product.maxQuantity || product.originalQuantity"
                        (input)="validateReturnQuantity(product)"
                      />
                      <small class="quantity-info">0 - {{ product.maxQuantity || product.originalQuantity }} arası</small>
                    </div>
                    <div class="product-pricing">
                      <div class="pricing-row">
                        <span>Birim Fiyat:</span>
                        <span>{{ formatCurrency(product.unitPrice) }}</span>
                      </div>
                      <div class="pricing-row">
                        <span>Ara Toplam:</span>
                        <span>{{ formatCurrency(product.subtotal) }}</span>
                      </div>
                      <div class="pricing-row total">
                        <span>İade Tutarı:</span>
                        <span>{{ formatCurrency(product.totalPrice) }}</span>
                      </div>
                    </div>
                    <div class="product-actions">
                      <button type="button" class="btn btn-danger btn-sm" (click)="removeProductFromReturn(product.id)">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
          
          <!-- Return Summary -->
          @if (returnProducts.length > 0) {
            <div class="return-summary">
              <div class="summary-row">
                <span>Toplam İade Tutarı:</span>
                <span class="total-amount">{{ formatCurrency(calculateReturnTotal()) }}</span>
              </div>
            </div>
          }
        </div>
        
        <div class="modal-footer">
          <div class="footer-actions">
            <button type="button" class="btn btn-secondary" (click)="closeReturnModal()">
              <i class="fas fa-times"></i> İptal
            </button>
            <button type="button" class="btn btn-warning" (click)="saveReturn()" [disabled]="returnProducts.length === 0 || isSavingReturn">
              <i class="fas fa-save"></i> {{ isSavingReturn ? 'Kaydediliyor...' : 'İade Kaydet' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Return Product Selection Modal -->
  @if (showReturnProductModal) {
    <div class="modal-overlay" (click)="closeReturnProductModal()">
      <div class="modal-content product-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <div class="header-content">
            <h3><i class="fas fa-undo"></i> İade Ürünü Seç</h3>
            <button type="button" class="modal-close" (click)="closeReturnProductModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        
        <div class="modal-body">
          <!-- Product Selection -->
          <div class="product-selection">
            <div class="section-title">
              <i class="fas fa-search"></i>
              <span>Ürün Seçimi</span>
            </div>
            
            <div class="product-selector">
              <select [(ngModel)]="selectedReturnProduct" class="form-input" (change)="onReturnProductSelect()">
                <option value="">Ürün seçin</option>
                @for (product of availableProducts; track product.id) {
                  <option [value]="product.id">{{ product.name }} - {{ formatCurrency(product.price) }}</option>
                }
              </select>
            </div>
            
            @if (selectedReturnProduct) {
              <div class="selected-product-info">
                <div class="product-details">
                  <div class="product-detail-item">
                    <label>Ürün Kodu:</label>
                    <span>{{ getSelectedReturnProductCode() }}</span>
                  </div>
                  <div class="product-detail-item">
                    <label>Birim Fiyat:</label>
                    <span>{{ formatCurrency(getSelectedReturnProductPrice()) }}</span>
                  </div>
                </div>
              </div>
            }
          </div>
          
          <!-- Quantity -->
          <div class="quantity-section">
            <div class="section-title">
              <i class="fas fa-cubes"></i>
              <span>Miktar</span>
            </div>
            
            <div class="input-item">
              <label><i class="fas fa-cubes"></i> İade Miktarı</label>
              <input type="number" [(ngModel)]="returnProductQuantity" class="form-input" placeholder="1" min="1">
            </div>
          </div>
          
          <!-- Calculation Preview -->
          @if (selectedReturnProduct && returnProductQuantity > 0) {
            <div class="calculation-preview">
              <div class="section-title">
                <i class="fas fa-calculator"></i>
                <span>Hesaplama</span>
              </div>
              
              <div class="calculation-details">
                <div class="calc-row">
                  <span>Birim Fiyat:</span>
                  <span>{{ formatCurrency(getSelectedReturnProductPrice()) }}</span>
                </div>
                <div class="calc-row">
                  <span>Miktar:</span>
                  <span>{{ returnProductQuantity }} adet</span>
                </div>
                <div class="calc-row total">
                  <span>İade Tutarı:</span>
                  <span>{{ formatCurrency(getSelectedReturnProductPrice() * returnProductQuantity) }}</span>
                </div>
              </div>
            </div>
          }
        </div>
        
        <div class="modal-footer">
          <div class="footer-actions">
            <button type="button" class="btn btn-secondary" (click)="closeReturnProductModal()">
              <i class="fas fa-times"></i> İptal
            </button>
            <button type="button" class="btn btn-warning" (click)="addProductToReturn()" [disabled]="!selectedReturnProduct || returnProductQuantity <= 0">
              <i class="fas fa-plus"></i> İadeye Ekle
            </button>
          </div>
        </div>
      </div>
    </div>
  }
</div>
