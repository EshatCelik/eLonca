<div class="customers-page">
  <div class="page-header">
    <h1>Müşteriler</h1>
    <button class="btn btn-primary add-btn" (click)="onAddCustomer()">
      <i class="fas fa-plus"></i> Yeni Müşteri
    </button>
  </div>
  
  @if (isLoading) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Yükleniyor...</p>
    </div>
  }

  @if (!isLoading && customers.length > 0) {
    <div class="customers-table-container">
      <table class="customers-table">
        <thead>
          <tr>
            <th>Müşteri Kodu</th>
            <th>Müşteri Adı</th>
            <th>İndirim Oranı</th>
            <th>Telefon</th>
            <th>Email</th>
            <th>Müşteri Tipi</th>
            <th>Durum</th>
            <th>İşlemler</th>
          </tr>
        </thead>
        <tbody>
          @for (customer of customers; track customer.id) {
            <tr class="customer-row" (click)="onCustomerClick(customer)">
              <td class="customer-code">{{ customer.customerCode || '-' }}</td>
              <td class="customer-storeName">{{ customer.storeName  }}</td>
              <td class="discount-rate">
                @if (customer.discountRate || customer.discount) {
                  <span class="discount-badge">{{ customer.discountRate || customer.discount || 0 }}%</span>
                } @else {
                  -
                }
              </td>
              <td class="customer-phone">{{ customer.phoneNumber || customer.phone || '-' }}</td>
              <td class="customer-email">{{ customer.email || '-' }}</td>
              <td class="customer-type">{{ getCustomerType( customer.customerType) }}</td>
              <td class="customer-status">
                <span class="status-badge" [ngClass]="{
                  'active': customer.isActive,
                  'inactive': !customer.isActive
                }">
                  {{ customer.isActive ? 'Aktif' : 'Pasif' }}
                </span>
              </td>
              <td class="customer-actions">
                <button class="btn btn-sm btn-danger" (click)="onDeleteCustomer(customer, $event); $event.stopPropagation()" [disabled]="deletingId === getId(customer)">
                  <i class="fas fa-trash"></i> {{ deletingId === getId(customer) ? 'Siliniyor...' : 'Sil' }}
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  @if (!isLoading && customers.length === 0) {
    <div class="empty-state">
      <i class="fas fa-users"></i>
      <h3>Müşteri Bulunamadı</h3>
      <p>Henüz kayıtlı müşteri bulunmamaktadır.</p>
      <button class="btn btn-primary" (click)="onAddCustomer()">
        <i class="fas fa-plus"></i> İlk Müşteriyi Ekle
      </button>
    </div>
  }

  @if (showCreateModal) {
    <div class="modal-overlay" (click)="onCloseModal()">
      <div class="modal-container panel-style" (click)="$event.stopPropagation()">
        <div class="panel-header">
          <h1>Yeni Müşteri Ekle</h1>
          <button type="button" class="btn btn-secondary" (click)="onCloseModal()">İptal</button>
        </div>

        <div class="panel-content">
          <div class="info-section">
            <h2>Müşteri Bilgileri</h2>
            
            <!-- Store Search Section -->
            <div class="search-section">
              <h3>Mağaza Ara</h3>
              <div class="search-container">
                <input 
                  type="text" 
                  [(ngModel)]="searchQuery" 
                  (input)="onSearchStores()" 
                  class="form-input search-input" 
                  placeholder="Mağaza adı ile arayın..." 
                />
                @if (isSearching) {
                  <div class="search-loading">Aranıyor...</div>
                }
              </div>
              
              @if (searchResults.length > 0) {
                <div class="search-results">
                  <h4>Sonuçlar:</h4>
                  @for (result of searchResults; track result.id) {
                    <div class="search-result-item" (click)="onSelectStore(result)">
                      <div class="result-name">{{ result.name || result.storeName }}</div>
                      <div class="result-details">
                        @if (result.phone) {
                          <span class="result-detail">{{ result.phone }}</span>
                        }
                        @if (result.email) {
                          <span class="result-detail">{{ result.email }}</span>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>

            <div class="info-grid"> 
              <div class="info-item">
                <label>Mağaza Adı:</label>
                <input type="text" [(ngModel)]="createModel.firstName" [readonly]="true" class="form-input" placeholder="Mağaza adı" />
              </div> 
              <div class="info-item">
                <label>Müşteri Tipi:</label>
                <select [(ngModel)]="createModel.customerType" class="form-input">
                  <option value="">Müşteri tipi seçin</option>
                  <option value="Individual">Bireysel</option>
                  <option value="Corporate">Kurumsal</option>
                </select>
              </div>
              <div class="info-item">
                <label>İndirim Oranı:</label>
                <input type="number" [(ngModel)]="createModel.discountRate" class="form-input" placeholder="İndirim oranını girin (%)" />
              </div>
              <div class="info-item">
                <label>Telefon:</label>
                <input type="text" [(ngModel)]="createModel.phoneNumber" [readonly]="true" class="form-input" placeholder="Telefon numarası" />
              </div>
              <div class="info-item">
                <label>Email:</label>
                <input type="email" [(ngModel)]="createModel.email" [readonly]="true" class="form-input" placeholder="Email adresi" />
              </div>
              <div class="info-item full-width">
                <label>Adres:</label>
                <textarea [(ngModel)]="createModel.address" [readonly]="true" class="form-input" placeholder="Adres" rows="3"></textarea>
              </div>
            </div>
          </div>

          <div class="panel-actions">
            <button type="button" class="btn btn-secondary" (click)="onCloseModal()" [disabled]="isCreating">
              İptal
            </button>
            <button type="button" class="btn btn-primary" (click)="createCustomer()" [disabled]="isCreating || !createModel.storeId">
              @if (isCreating) {
                <span class="spinner"></span>
                Kaydediliyor...
              } @else {
                Müşteri Ekle
              }
            </button>
          </div>
        </div>
      </div>
    </div>
  }
</div>
